import datetime
from utils.time_series_conversion import date_to_offset_julian


def calculate_vulnerability(matrix, limits, inputs):

    abs_vul = None

    lower_limit = limits['lower_limit']
    upper_limit = limits['upper_limit']

    start_indx = date_to_offset_julian(
        inputs["bioperiod_start_date"]+"/2000", "10/01") - 1
    end_indx = date_to_offset_julian(
        inputs["bioperiod_end_date"]+"/2000", "10/01") - 1

    scenario = matrix['scenario']
    percentile = matrix['percentile']

    abs_vul = 0
    median = 0

    for i in range(start_indx, end_indx + 1):
        lower_diff = float(scenario[i]) - float(percentile[i][lower_limit])
        upper_diff = float(
            percentile[i][upper_limit]) - float(scenario[i])

        if lower_diff < 0:
            abs_vul = abs_vul + abs(lower_diff)
        elif upper_diff < 0:
            abs_vul = abs_vul + abs(upper_diff)

        median = median + float(percentile[i]['50th'])

    return abs_vul/median
